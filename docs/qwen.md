# Документация для разработчиков

## Обзор скрипта setup.sh

Скрипт `setup.sh` предназначен для автоматической установки и настройки мульти-протокольного VPN-сервера с поддержкой VLESS+Reality, Shadowsocks-2022 и AmneziaWG.

## Архитектура

Система состоит из следующих компонентов:

1. **Xray Core** - для протоколов VLESS+Reality и Shadowsocks-2022
2. **WireGuard** (в режиме AmneziaWG) - для высокоскоростного туннелирования
3. **Docker Compose** - для управления контейнерами

## Структура проекта

```
├── setup.sh              # Основной скрипт установки
├── .env.template         # Шаблон конфигурационного файла
├── configs/              # Шаблоны конфигураций
│   └── xray.json.template
├── docker-compose.yml    # Определение сервисов Docker
├── README.md             # Документация для пользователей
└── docs/                 # Дополнительная документация
    ├── qwen.md          # Документация для разработчиков
    └── roadmap.md       # План развития проекта
```

## Основные функции скрипта

### 1. `generate_secrets()`

Генерирует криптографические параметры:
- UUID для VLESS
- Ключи для X25519 (REALITY)
- Краткие ID
- Пароли для Shadowsocks-2022
- Ключи для AmneziaWG
- Параметры обфускации WireGuard

### 2. `create_configs()`

Создает шаблоны конфигурационных файлов:
- Xray конфигурация с поддержкой REALITY
- Параметры подключения

### 3. `prepare_configs()`

Заменяет шаблонные переменные на реальные значения:
- Использует `envsubst` для подстановки значений
- Создает готовые конфиги для Docker-контейнеров

### 4. `start_services()`

Запускает Docker-контейнеры:
- xray-core
- amnezia-wg

## Критические изменения в версии 2.0

### Проблема с пустыми переменными

**Проблема**: Предыдущая версия скрипта не могла корректно обработать ситуацию, когда файл `.env` существовал, но содержал пустые значения переменных. Это приводило к ошибке `unbound variable` при попытке использовать переменную `WG_CLIENT_PRIVATE_KEY`.

**Решение**: 
1. В функции `generate_secrets()` добавлена проверка на пустые значения переменных
2. Если обнаружены пустые значения, скрипт перегенерирует недостающие параметры
3. В функциях `prepare_configs()` и `show_connection_info()` добавлена проверка на определенность всех необходимых переменных перед их использованием

### Проверка переменных

Теперь перед использованием критических переменных в функциях `prepare_configs()` и `show_connection_info()` производится проверка, что все необходимые переменные определены и не пусты:

```bash
if [[ -z "${UUID:-}" ]] || [[ -z "${PRIVATE_KEY:-}" ]] || ...; then
    log_error "Не все необходимые переменные определены. Пожалуйста, проверьте файл .env"
    exit 1
fi
```

## Безопасность

1. Все криптографические параметры генерируются локально
2. Ключи хранятся в файле `.env` с ограниченными правами доступа
3. Используется безопасная генерация случайных данных через OpenSSL
4. Файл `.gitignore` исключает `.env` из репозитория

## Расширение функциональности

Для добавления новых протоколов:
1. Добавьте новые параметры в `.env.template`
2. Обновите функцию `generate_secrets()` для генерации соответствующих ключей
3. Добавьте конфигурацию в шаблоны в папке `configs/`
4. Обновите `docker-compose.yml` для нового сервиса
5. Добавьте генерацию QR-кода и информацию для подключения в `show_connection_info()`

## Отладка

Для отладки работы скрипта:
1. Проверьте содержимое `.env` файла
2. Убедитесь, что все зависимости установлены
3. Проверьте права доступа к файлам
4. Изучите логи Docker-контейнеров

## Тестирование

Скрипт можно тестировать в изолированной среде:
1. Использовать виртуальную машину
2. Проверить работу всех протоколов
3. Убедиться, что QR-коды генерируются корректно
4. Проверить восстановление после частичного сбоя