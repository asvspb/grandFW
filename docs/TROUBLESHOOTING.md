# Решение проблем (Troubleshooting)

## Общие проблемы

### 1. Ошибка установки зависимостей

**Проблема**: Установка зависимостей завершается с ошибкой

**Решение**:
1. Обновите систему: `sudo apt update && sudo apt upgrade`
2. Проверьте подключение к интернету
3. Запустите установку снова: `sudo ./setup.sh`

### 2. Порт уже используется

**Проблема**: Ошибка "Port is already allocated"

**Решение**:
1. Проверьте, что использует порт: `sudo lsof -i :8443`
2. Остановите конфликтующее приложение
3. Перезапустите установку

### 3. Docker не запускается

**Проблема**: Ошибка при запуске Docker контейнеров

**Решение**:
1. Запустите Docker вручную: `sudo systemctl start docker`
2. Проверьте статус: `sudo systemctl status docker`
3. Если не помогает, перезапустите систему

## Проблемы с подключением

### 1. Клиент не может подключиться к VLESS

**Проверьте**:
- Порт 8443 открыт в firewall: `sudo ufw status`
- Контейнер xray запущен: `docker compose ps`
- Серверное имя (SNI) правильно настроено
- Сертификаты действительны

**Решения**:
1. Проверьте логи: `docker compose logs xray`
2. Убедитесь, что DNS настроен правильно
3. Попробуйте использовать другое доменное имя для SNI

### 2. Клиент не может подключиться к Shadowsocks

**Проверьте**:
- Порт 9443 открыт в firewall
- Контейнер xray запущен
- Пароль корректен

**Решения**:
1. Проверьте логи: `docker compose logs xray`
2. Убедитесь, что используете правильный метод шифрования (2022-blake3-aes-128-gcm)

### 3. Клиент не может подключиться к AmneziaWG

**Проверьте**:
- Порт 51820/udp открыт в firewall
- Контейнер amnezia-wg запущен
- Конфигурация корректна

**Решения**:
1. Проверьте логи: `docker compose logs amnezia-wg`
2. Убедитесь, что IP-адрес в конфиге правильный
3. Проверьте, что UDP-трафик не блокируется провайдером

## Проблемы с безопасностью

### 1. Command injection уязвимость

**Проблема**: Подозрение на уязвимость в загрузке .env

**Решение**: 
- Убедитесь, что используется `load_env_safe()` функция
- Проверьте, что .env файл не содержит исполняемых команд
- Используйте `export $(grep -v '^#' .env | xargs)` только в доверенных окружениях

### 2. Небезопасные права доступа к .env

**Проблема**: Файл .env доступен для чтения другими пользователями

**Решение**:
1. Установите правильные права: `chmod 600 .env`
2. Установите владельца: `sudo chown root:root .env`

## Диагностика и отладка

### 1. Проверка состояния сервисов

```bash
# Проверка состояния контейнеров
docker compose ps

# Проверка логов xray
docker compose logs xray

# Проверка логов amnezia-wg
docker compose logs amnezia-wg

# Проверка открытых портов
netstat -tulnp | grep -E "(8443|9443|51820)"

# Проверка firewall правил
sudo ufw status
```

### 2. Запуск диагностики

```bash
# Запуск скрипта диагностики
sudo ./health-check.sh

# Запуск тестов
./tests/run_tests.sh all
```

### 3. Проверка конфигурации

```bash
# Проверка синтаксиса конфигурации xray
docker run --rm -i teddysun/xray xray -test -config=/dev/stdin < xray_config.json

# Проверка .env файла
./lib/env_loader.sh -c "load_env_safe .env && echo 'OK'"
```

## Восстановление

### 1. Восстановление из резервной копии

```bash
# Восстановление .env файла из резервной копии
sudo cp backups/.env.backup.date .env
sudo chmod 600 .env

# Перезапуск сервисов
docker compose down && docker compose up -d
```

### 2. Сброс конфигурации

```bash
# Остановка сервисов
docker compose down

# Удаление конфигурационных файлов
rm -f xray_config.json amnezia_*.conf .env

# Перезапуск установки
sudo ./setup.sh
```

## Отладка в режиме DEBUG

Для включения отладки добавьте в .env файл:

```bash
DEBUG=true
```

Или запустите скрипт с переменной:

```bash
DEBUG=true sudo ./setup.sh
```

## Поддержка

Если проблемы не удается решить самостоятельно:

1. Проверьте существующие issue: https://github.com/asvspb/grandFW/issues
2. Создайте новое issue с описанием проблемы
3. Приложите логи и вывод команд диагностики
4. Укажите версию системы и компонентов

Контакты:
- Email: asvdevpro@gmail.com
- GitHub Issues: https://github.com/asvspb/grandFW/issues