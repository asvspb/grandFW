# Архитектурная документация grandFW v3.0

## Обзор архитектуры

Проект grandFW v3.0 использует модульную архитектуру с разделением на независимые библиотеки:

```
grandFW/
├── lib/                          # Библиотеки
│   ├── common.sh                 # Общие функции (логирование, проверки)
│   ├── validation.sh             # Валидация данных (UUID, IP, порты)
│   ├── crypto.sh                 # Криптографические функции
│   ├── env_loader.sh             # Безопасная загрузка .env
│   ├── docker.sh                 # Работа с Docker
│   └── firewall.sh               # Настройка UFW
│
├── scripts/                      # Исполняемые скрипты
│   ├── setup.sh                  # Главный скрипт установки
│   ├── health-check.sh           # Проверка работоспособности
│   ├── update.sh                 # Обновление конфигурации
│   ├── backup.sh                 # Резервное копирование
│   └── uninstall.sh              # Удаление
│
├── configs/                      # Шаблоны конфигураций
│   ├── xray.json.template        # Шаблон конфигурации Xray
│   └── docker-compose.yml        # Docker Compose конфигурация
│
├── tests/                        # Тесты
│   ├── test_helpers.sh           # Вспомогательные функции для тестов
│   ├── run_tests.sh              # Запуск всех тестов
│   ├── unit/                     # Unit тесты
│   │   ├── test_common.sh
│   │   ├── test_validation.sh
│   │   ├── test_crypto.sh
│   │   ├── test_env_loader.sh
│   │   ├── test_docker.sh
│   │   └── test_firewall.sh
│   ├── integration/              # Integration тесты
│   │   ├── test_setup_workflow.sh
│   │   ├── test_config_generation.sh
│   │   └── test_firewall_rules.sh
│   └── e2e/                      # End-to-End тесты
│       └── test_connectivity.sh
│
├── .env.template                 # Шаблон переменных окружения
├── VERSION                       # Версия проекта
└── docs/                         # Документация
    ├── ARCHITECTURE.md           # Архитектурная документация
    ├── INSTALLATION.md           # Установка
    ├── TROUBLESHOOTING.md        # Решение проблем
    ├── EXAMPLES.md               # Примеры использования
    ├── IMPLEMENTATION_INDEX.md   # Индекс реализации
    ├── PLAN_01_LIBRARIES.md      # План 1: Создание библиотек
    ├── PLAN_02_CRITICAL_FIXES.md # План 2: Исправление критических багов
    ├── PLAN_03_TESTING.md        # План 3: Тестирование
    ├── PLAN_04_CICD.md           # План 4: CI/CD
    ├── qwen.md                   # Архитектурная документация
    └── roadmap.md                # Дорожная карта
```

## Принципы архитектуры

1. **Модульность**: Разделение на независимые модули с четкими интерфейсами
2. **Единственная ответственность**: Каждая функция делает одну вещь
3. **Безопасность по умолчанию**: Валидация всех входных данных
4. **Идемпотентность**: Повторный запуск не ломает систему
5. **Тестируемость**: Все функции покрыты тестами
6. **Обработка ошибок**: Graceful degradation и rollback
7. **Конфигурируемость**: Все параметры настраиваются через .env файл

## Библиотеки

### lib/common.sh
Содержит общие функции:
- Функции логирования (log, log_info, log_warn, log_error, log_debug)
- Проверка прав root (check_root)
- Проверка зависимостей (check_dependency)
- Создание резервных копий (backup_file)
- Получение внешнего IP (get_external_ip)
- Проверка доступности портов (check_port_available)
- Запрос подтверждения (confirm)
- Вспомогательные функции для работы с системой

### lib/validation.sh
Содержит функции валидации:
- validate_uuid() - проверка формата UUID
- validate_port() - проверка номера порта
- validate_ip() - проверка IP адреса
- validate_domain() - проверка доменного имени
- validate_base64() - проверка base64 строки
- check_port_conflicts() - проверка конфликта портов
- validate_env_vars() - валидация всех переменных окружения
- Валидация других параметров конфигурации

### lib/crypto.sh
Содержит криптографические функции:
- generate_uuid() - генерация UUID v4
- generate_x25519_keys() - генерация X25519 ключей для Reality
- generate_short_id() - генерация короткого ID (8 hex символов)
- generate_ss_password() - генерация пароля для Shadowsocks-2022
- generate_wg_keys() - генерация WireGuard ключей
- generate_wg_preshared() - генерация WireGuard preshared key
- generate_random_number() - генерация случайного числа в диапазоне
- generate_all_secrets() - генерация всех секретов проекта
- Проверка корректности сгенерированных ключей

### lib/env_loader.sh
Содержит функции для безопасной загрузки переменных окружения:
- load_env_safe() - безопасная загрузка .env файла
- save_env_file() - сохранение переменных в .env файл
- Проверка формата переменных
- Защита от command injection

### lib/docker.sh
Содержит функции для работы с Docker:
- check_docker_installed() - проверка установки Docker
- check_docker_running() - проверка работы Docker daemon
- docker_compose_up() - запуск контейнеров через Docker Compose
- docker_compose_down() - остановка контейнеров
- docker_compose_restart() - перезапуск контейнеров
- get_container_status() - получение статуса контейнера
- cleanup_conflicting_containers() - очистка конфликтующих контейнеров

### lib/firewall.sh
Содержит функции для настройки UFW:
- setup_firewall() - настройка базовых правил UFW
- open_port() - открытие порта
- close_port() - закрытие порта
- Проверка состояния firewall
- Управление правилами безопасности

## Исполняемые скрипты

### scripts/setup.sh
Главный скрипт установки, который:
- Проверяет зависимости и устанавливает недостающие
- Проверяет права root
- Инициализирует или загружает конфигурацию
- Генерирует криптографические параметры
- Создает конфигурационные файлы из шаблонов
- Настраивает firewall
- Запускает Docker контейнеры
- Проверяет работоспособность
- Выводит информацию для подключения
- Создает файл connection_guide.txt

### scripts/health-check.sh
Скрипт для проверки работоспособности:
- Проверяет состояние Docker
- Проверяет состояние контейнеров
- Проверяет открытые порты
- Проверяет конфигурационные файлы
- Проверяет .env файл
- Проверяет, что службы отвечают
- Проверяет сетевую доступность

### scripts/update.sh
Скрипт для обновления конфигураций:
- Обновляет конфигурационные файлы
- Перезапускает контейнеры при необходимости
- Проверяет совместимость версий

### scripts/backup.sh
Скрипт для резервного копирования:
- Создает архив с конфигурациями
- Сохраняет критические файлы
- Управляет версиями резервных копий

### scripts/uninstall.sh
Скрипт для удаления:
- Останавливает контейнеры
- Удаляет конфигурации
- Очищает правила firewall
- Удаляет временные файлы

## Архитектура конфигураций

### .env файл
Содержит все параметры конфигурации:
- Параметры сервера (SERVER_NAME, SNI, EXTERNAL_IP)
- Порты для протоколов (PORT_VLESS, PORT_SHADOWSOCKS, PORT_AMNEZIAWG)
- Криптографические параметры (UUID, ключи, пароли)
- Параметры обфускации AmneziaWG

### Шаблоны конфигураций
- configs/xray.json.template - шаблон для конфигурации Xray
- docker-compose.yml - конфигурация для Docker Compose

## Безопасность

- Все переменные окружения загружаются безопасно через `load_env_safe()`
- Файл .env защищен правами доступа 600
- Все входные данные валидируются
- Защита от command injection уязвимостей
- Использование envsubst вместо unsafe shell evaluation
- Проверка конфликтов портов
- Правила firewall по умолчанию

## Тестирование

### Unit тесты
- Тестирование каждой функции отдельно
- Проверка валидации данных
- Проверка криптографических функций
- Проверка безопасной загрузки переменных

### Integration тесты
- Проверка взаимодействия между модулями
- Проверка рабочих процессов
- Проверка генерации конфигураций
- Проверка настройки firewall

### E2E тесты
- Проверка реальных подключений (планируется)
- Проверка работоспособности сервисов
- Проверка доступности портов

## CI/CD

- Автоматические тесты при каждом push/PR
- ShellCheck анализ
- Проверка безопасности
- Создание релизов при тегировании
- Проверка синтаксиса скриптов
- Проверка работоспособности конфигураций

## Поток выполнения

1. **Инициализация**: Загрузка библиотек и проверка зависимостей
2. **Конфигурация**: Загрузка или генерация параметров
3. **Валидация**: Проверка всех параметров на корректность
4. **Подготовка**: Создание конфигурационных файлов
5. **Установка**: Настройка firewall и запуск контейнеров
6. **Проверка**: Тестирование работоспособности
7. **Вывод**: Генерация информации для подключения