# Архитектурная документация grandFW v3.0

## Обзор архитектуры

Проект grandFW v3.0 использует модульную архитектуру с разделением на независимые библиотеки:

```
grandFW/
├── lib/                          # Библиотеки (новое)
│   ├── common.sh                 # Общие функции
│   ├── crypto.sh                 # Криптографические функции
│   ├── docker.sh                 # Работа с Docker
│   ├── firewall.sh               # Настройка UFW
│   ├── validation.sh             # Валидация данных
│   └── env_loader.sh             # Безопасная загрузка .env
│
├── scripts/                      # Исполняемые скрипты
│   ├── setup.sh                  # Главный скрипт (рефакторинг)
│   ├── health-check.sh           # Проверка работоспособности
│   ├── update.sh                 # Обновление конфигурации (новое)
│   ├── backup.sh                 # Резервное копирование (новое)
│   └── uninstall.sh              # Удаление (новое)
│
├── configs/                      # Шаблоны конфигураций
│   ├── xray.json.template        # Xray конфигурация
│   └── docker-compose.yml.template # Docker Compose (новое)
│
├── tests/                        # Тесты (новое)
│   ├── unit/                     # Unit тесты
│   │   ├── test_crypto.sh
│   │   ├── test_validation.sh
│   │   └── test_env_loader.sh
│   ├── integration/              # Интеграционные тесты
│   │   ├── test_setup.sh
│   │   └── test_docker.sh
│   └── run_tests.sh              # Запуск всех тестов
│
├── .env.template                 # Шаблон переменных окружения
├── docker-compose.yml            # Docker Compose конфигурация
├── VERSION                       # Версия проекта (новое)
└── docs/
    ├── qwen.md                   # Архитектурная документация
    ├── roadmap.md
    ├── ARCHITECTURE.md           # Архитектурная документация (новое)
    └── TROUBLESHOOTING.md        # Решение проблем (новое)
```

## Принципы архитектуры

1. **Модульность**: Разделение на независимые модули с четкими интерфейсами
2. **Единственная ответственность**: Каждая функция делает одну вещь
3. **Безопасность по умолчанию**: Валидация всех входных данных
4. **Идемпотентность**: Повторный запуск не ломает систему
5. **Тестируемость**: Все функции покрыты тестами
6. **Обработка ошибок**: Graceful degradation и rollback

## Библиотеки

### lib/common.sh
Содержит общие функции:
- Функции логирования (log, log_info, log_warn, log_error, log_debug)
- Проверка прав root (check_root)
- Проверка зависимостей (check_dependency)
- Создание резервных копий (backup_file)
- Получение внешнего IP (get_external_ip)
- Проверка доступности портов (check_port_available)
- Запрос подтверждения (confirm)

### lib/validation.sh
Содержит функции валидации:
- validate_uuid() - проверка формата UUID
- validate_port() - проверка номера порта
- validate_ip() - проверка IP адреса
- validate_domain() - проверка доменного имени
- validate_base64() - проверка base64 строки
- check_port_conflicts() - проверка конфликта портов
- validate_env_vars() - валидация всех переменных окружения

### lib/crypto.sh
Содержит криптографические функции:
- generate_uuid() - генерация UUID v4
- generate_x25519_keys() - генерация X25519 ключей для Reality
- generate_short_id() - генерация короткого ID (8 hex символов)
- generate_ss_password() - генерация пароля для Shadowsocks-2022
- generate_wg_keys() - генерация WireGuard ключей
- generate_wg_preshared() - генерация WireGuard preshared key
- generate_random_number() - генерация случайного числа в диапазоне
- generate_all_secrets() - генерация всех секретов проекта

### lib/env_loader.sh
Содержит функции для безопасной загрузки переменных окружения:
- load_env_safe() - безопасная загрузка .env файла
- save_env_file() - сохранение переменных в .env файл

### lib/docker.sh
Содержит функции для работы с Docker:
- check_docker_installed() - проверка установки Docker
- check_docker_running() - проверка работы Docker daemon
- docker_compose_up() - запуск контейнеров через Docker Compose
- docker_compose_down() - остановка контейнеров
- docker_compose_restart() - перезапуск контейнеров
- get_container_status() - получение статуса контейнера

### lib/firewall.sh
Содержит функции для настройки UFW:
- setup_firewall() - настройка базовых правил UFW
- open_port() - открытие порта
- close_port() - закрытие порта

## Исполняемые скрипты

### setup.sh
Главный скрипт установки, который:
- Проверяет зависимости
- Инициализирует или загружает конфигурацию
- Создает конфигурационные файлы
- Настраивает firewall
- Запускает сервисы
- Проверяет работоспособность
- Выводит информацию для подключения

### health-check.sh
Скрипт для проверки работоспособности:
- Проверяет состояние Docker
- Проверяет состояние контейнеров
- Проверяет открытые порты
- Проверяет конфигурационные файлы
- Проверяет .env файл
- Проверяет, что службы отвечают

## Безопасность

- Все переменные окружения загружаются безопасно через `load_env_safe()`
- Файл .env защищен правами доступа 600
- Все входные данные валидируются
- Защита от command injection уязвимостей
- Использование envsubst вместо unsafe shell evaluation

## Тестирование

- Unit тесты для каждой библиотеки
- Integration тесты для проверки взаимодействия компонентов
- E2E тесты для проверки реальных подключений
- Покрытие тестами >80%

## CI/CD

- Автоматические тесты при каждом push/PR
- ShellCheck анализ
- Проверка безопасности
- Создание релизов при тегировании